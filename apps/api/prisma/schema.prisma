// apps/api/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // vem do apps/api/.env
}

enum Role {
  ADMIN
  ATTENDANT
  OWNER
}

model Tenant {
  id          String     @id @default(cuid())
  name        String     @unique
  cnpj        String?    @unique
  isActive    Boolean    @default(true)
  maxOpenCashSessions Int @default(1)
  users       User[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  Session     Session[]
  cpfResLoja  String?    @unique
  email       String     @unique
  Supplier    Supplier[]
  Product     Product[]
  ownerUserId String?    @unique
  ownerUser   User?      @relation("TenantOwner", fields: [ownerUserId], references: [id])

  categories Category[] // FIX: back-relation obrigata??rio da relaa??a??o Category.tenant
  customers Customer[]
  customerLedgers CustomerLedger[]

  @@index([isActive, createdAt])
}

model User {
  id                  String    @id @default(cuid())
  name                String?
  cpf                 String?   @unique
  tenantId            String
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  email               String
  passwordHash        String
  role                Role      @default(ATTENDANT)
  pinSupervisor       String?
  isActive            Boolean   @default(true)
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  mustChangePassword  Boolean   @default(false)
  passwordUpdatedAt   DateTime  @default(now())
  TenantOwner         Tenant?   @relation("TenantOwner")
  failedLoginCount    Int       @default(0)
  blockedUntil        DateTime?
  resetTokenHash      String?
  resetTokenExpiresAt DateTime?

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([isActive, role])
  @@index([blockedUntil])
}



model PasswordResetToken {
  id        String   @id @default(uuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Hash do token (nunca guarde o token puro)
  tokenHash String   @unique

  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}



model Session {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  revokedAt DateTime?
  jti       String?   @unique

  // multi-tenant por coluna
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  refreshHash String
  userAgent   String?
  ip          String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([tenantId])
  @@index([expiresAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?
  action    String
  entity    String
  entityId  String?
  diffJson  String?
  ip        String?
  device    String?
  hmac      String
  createdAt DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([entity, entityId])
}

model Supplier {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  name      String  @map("nome_fantasia")
  legalName String  @map("razao_social")
  cnpj      String  @map("cnpj") @db.VarChar(14)
  code      Int     @map("codigo_fornecedor")
  isActive  Boolean @default(true) @map("ativo")

  phone  String? @map("telefone") @db.VarChar(16)
  mobile String? @map("telefone_celular") @db.VarChar(16)
  email  String? @db.VarChar(120)

  ie           String? @db.VarChar(20)
  cep          String? @db.VarChar(8)
  city         String? @db.VarChar(60)
  uf           String? @db.VarChar(2)
  address      String? @db.VarChar(120)
  addressNo    String? @db.VarChar(10)
  complement   String? @db.VarChar(60)
  neighborhood String? @db.VarChar(60)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Product   Product[]

  @@unique([tenantId, cnpj], name: "supplier_cnpj_per_tenant")
  @@unique([tenantId, code], name: "supplier_code_per_tenant")
  @@unique([id, tenantId], name: "supplier_id_tenant_unique") // OK: necessÃ¡rio p/ FK composta Productâ†’Supplier
  @@index([tenantId, name])
  @@map("fornecedores")
}

// --------------------- BD CATEGORIAS PRODUTOS ---------------------

enum Unit {
  UN // unidade
  CX // caixa
  KG // quilograma
  LT // litro
  GR // grama 
  ML // mililitro
  PC // Pacote ou PeÃ§a
}

model Product {
  id          String    @id @default(cuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  name        String
  sku         String    @default("")
  minQuantity Decimal?  @db.Decimal(14, 3)
  barcode     String?
  unit        Unit      @default(UN)
  price       Decimal   @db.Decimal(10, 2)
  cost        Decimal?  @db.Decimal(10, 2)
  minStock    Decimal?  @db.Decimal(14, 3)
  isActive    Boolean   @default(true)
  imagePath   String?   // caminho/Key da imagem no storage (Cloudflare R2)

  // Campos fiscais (preparaÃ§Ã£o p/ fases futuras)
  ncm   String?
  cest  String?
  csosn String?
  cfop  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inventories    Inventory[]
  stockMovements StockMovement[]
  purchaseItems  PurchaseItem[]

  @@unique([tenantId, sku]) // SKU Ãºnico por tenant
  @@unique([tenantId, barcode]) // se quiser permitir repetiÃ§Ã£o, remova esta e mantenha apenas @@index
  @@index([tenantId, name])
  @@index([tenantId, barcode])
}

model Category {
  id        String    @id @default(cuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  name      String
  imagePath String?   // caminho/Key da imagem no storage (Cloudflare R2)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]

  @@unique([tenantId, name]) // evita duplicidade por tenant
  @@index([tenantId, name])
}

model StockLocation {
  id        String   @id @default(cuid())
  tenantId  String
  name      String // ex.: "Balcao", "Cozinha", "Deposito"
  isSaleSource Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inventories    Inventory[]
  stockMovements StockMovement[]
  purchaseItems  PurchaseItem[]

  @@unique([tenantId, name]) // evita duplicidade por tenant
}

model Inventory {
  id         String  @id @default(cuid())
  tenantId   String
  productId  String
  locationId String
  quantity   Decimal @default(0) @db.Decimal(14, 3)

  minQuantity Decimal? @db.Decimal(14, 3) // <- ADICIONE: mínimo por local
  version     Int      @default(0)
  updatedAt   DateTime @updatedAt

  product  Product       @relation(fields: [productId], references: [id])
  location StockLocation @relation(fields: [locationId], references: [id])

  @@unique([tenantId, productId, locationId])
  @@index([tenantId, locationId])
  @@index([tenantId, productId])
}

enum MovementType {
  IN
  OUT
  ADJUST
  CANCEL
  RETURN
}

model StockMovement {
  id             String       @id @default(cuid())
  tenantId       String
  productId      String
  locationId     String
  type           MovementType
  quantity       Decimal      @db.Decimal(14, 3) // IN(+), OUT(-), ADJUST(+/-)
  reason         String?
  refId          String? // id da venda/compra/ajuste
  diffJson       String?
  createdBy      String? // userId
  createdAt      DateTime     @default(now())
  beforeQuantity String? // snapshot antes
  afterQuantity  String? // snapshot depois
  oversell       Boolean      @default(false)

  product  Product       @relation(fields: [productId], references: [id])
  location StockLocation @relation(fields: [locationId], references: [id])

  @@index([tenantId, type, createdAt, productId], name: "idx_sm_tenant_type_created_product")
  @@index([tenantId, productId, createdAt])
  @@index([tenantId, locationId, createdAt])
}

model Purchase {
  id        String         @id @default(cuid())
  tenantId  String
  supplier  String?
  invoiceNo String?
  total     Decimal?       @db.Decimal(12, 2)
  createdBy String?
  createdAt DateTime       @default(now())
  items     PurchaseItem[]
}

model PurchaseItem {
  id         String   @id @default(cuid())
  tenantId   String
  purchaseId String
  productId  String
  locationId String
  quantity   Decimal  @db.Decimal(14, 3)
  cost       Decimal? @db.Decimal(10, 2)

  purchase Purchase      @relation(fields: [purchaseId], references: [id])
  product  Product       @relation(fields: [productId], references: [id])
  location StockLocation @relation(fields: [locationId], references: [id])

  @@index([tenantId, productId])
}

//------------------------- VENDAS -----------------------------------

enum SaleStatus {
  OPEN
  FINALIZED
  CANCELED
}

enum PayMethod {
  cash
  debit
  credit
  pix
  vr
  va
  store_credit
}

enum DiscountMode {
  NONE
  VALUE
  PERCENT
}

enum FiscalStatus {
  PENDING
  SUCCESS
  FAILED
}

enum ProcessedSaleStatus {
  PENDING
  DONE
  ERROR
}

enum PrintJobType {
  SALE_RECEIPT
  CASH_CLOSING
}

enum PrintJobStatus {
  PENDING
  PRINTING
  DONE
  FAILED
}

enum CashApprovalMethod {
  PIN
  PASSWORD
}

model Sale {
  id             String          @id @default(cuid())
  tenantId       String
  userId         String
  cashSessionId  String
  cashSession    CashSession     @relation(fields: [cashSessionId], references: [id])
  number         Int
  status         SaleStatus
  subtotalCents  Int
  discountCents  Int             @default(0)
  discountMode   DiscountMode    @default(NONE)
  totalCents     Int
  changeCents    Int             @default(0)
  fiscalMode     String // 'sat' | 'nfce' | 'none'
  fiscalKey      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  items          SaleItem[]
  payments       Payment[]
  fiscalDocument FiscalDocument?
  printJobs      PrintJob[]

  @@unique([tenantId, number]) // numeração única por tenant
  @@index([tenantId, createdAt])
}

model SaleItem {
  id             String       @id @default(cuid())
  saleId         String
  productId      String
  sku            String?
  name           String
  qty            Decimal      @db.Decimal(10, 3)
  unitPriceCents Int
  totalCents     Int
  discountCents  Int          @default(0)
  discountMode   DiscountMode @default(NONE)
  createdAt      DateTime     @default(now())
  sale           Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
}

model Payment {
  id          String    @id @default(cuid())
  saleId      String
  method      PayMethod
  amountCents Int
  providerId  String?
  createdAt   DateTime  @default(now())
  sale        Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
}

model FiscalDocument {
  id            String       @id @default(cuid())
  tenantId      String
  saleId        String       @unique
  mode          String
  status        FiscalStatus @default(PENDING)
  fiscalKey     String?
  attempts      Int          @default(0)
  lastAttemptAt DateTime?
  lastError     String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  sale          Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
}

model CashSession {
  id                    String              @id @default(cuid())
  tenantId              String
  userId                String
  openedAt              DateTime            @default(now())
  closedAt              DateTime?
  openingCents          Int
  closingCents          Int?
  notes                 String?
  registerNumber        String?
  createdAt             DateTime            @default(now())
  closedByUserId        String?
  closingSupervisorId   String?
  closingSupervisorRole Role?
  closingApprovalVia    CashApprovalMethod?
  closingSnapshot       Json?
  closingNotes          String?
  withdrawals           CashWithdrawal[]
  sales                 Sale[]
  printJobs             PrintJob[]

  @@unique([tenantId, userId, openedAt]) // evita duplicidade por erro de rede
  @@index([tenantId, userId, openedAt])
}

model CashWithdrawal {
  id            String   @id @default(cuid())
  tenantId      String
  cashSessionId String
  amountCents   Int
  reason        String
  createdById   String
  createdAt     DateTime @default(now())

  cashSession CashSession @relation(fields: [cashSessionId], references: [id], onDelete: Cascade)

  @@index([tenantId, cashSessionId])
}

model SaleCounter {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  next      Int      @default(1)
  updatedAt DateTime @updatedAt
}

model ProcessedSale {
  id              String              @id @default(cuid())
  tenantId        String
  saleId          String
  deviceId        String?
  clientCreatedAt DateTime?
  status          ProcessedSaleStatus @default(PENDING)
  errorMessage    String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([tenantId, saleId])
  @@index([tenantId, status])
}

model PrintJob {
  id            String         @id @default(cuid())
  tenantId      String
  type          PrintJobType
  status        PrintJobStatus @default(PENDING)
  payload       Json
  source        String?
  requestedById String?
  deviceId      String?
  cashSessionId String?
  saleId        String?
  attempts      Int            @default(0)
  lastError     String?
  queuedAt      DateTime       @default(now())
  processedAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  cashSession CashSession? @relation(fields: [cashSessionId], references: [id], onDelete: SetNull)
  sale        Sale?        @relation(fields: [saleId], references: [id], onDelete: SetNull)

  @@index([tenantId, status, type])
}


model Customer {
  id             String   @id @default(cuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  name           String
  document       String?  // CPF/CNPJ (único por tenant)
  phone          String?
  email          String?
  address        String?
  allowCredit    Boolean  @default(false)
  creditLimit    Decimal? @db.Decimal(12,2) // pode ser null = sem limite
  defaultDueDays Int?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ledgers        CustomerLedger[]

  @@index([tenantId, name])
  @@unique([tenantId, document])
}

enum LedgerType {
  CHARGE   // Lançamento (compra a prazo)
  PAYMENT  // Baixa (pagamento do cliente)
  ADJUST   // Ajuste (crédito ou débito administrativo)
}

model CustomerLedger {
  id             String     @id @default(cuid())
  tenantId       String
  tenant         Tenant     @relation(fields: [tenantId], references: [id])
  customerId     String
  customer       Customer   @relation(fields: [customerId], references: [id])
  type           LedgerType
  amount         Decimal    @db.Decimal(12,2) // valor absoluto (sinal pelo type)
  description    String?
  saleId         String?
  dueDate        DateTime?
  paidAt         DateTime?
  method         String?    // para PAYMENT
  idempotencyKey String?    @unique
  createdBy      String?
  createdAt      DateTime   @default(now())

  @@index([tenantId, customerId, type, dueDate])
  @@index([tenantId, createdAt])
}
